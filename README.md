<xaiArtifact artifact_id="1ac44f68-43e9-4a43-9d29-1734e5cbd314" artifact_version_id="3f4f96a1-6419-4207-a0bb-6bdc09cfcd1d" title="README.md" contentType="text/markdown">

# 📚 کتابخانه MarketStructureLibrary - ابزار جامع تحلیل بازار برای MQL5

**MarketStructureLibrary.mqh** یک کتابخانه قدرتمند و منعطف برای MetaTrader 5 است که برای تحلیل پیشرفته ساختار بازار و شناسایی شکاف ارزش منصفانه (FVG) طراحی شده است. این کتابخانه با پشتیبانی از چند تایم‌فریم و چند نماد، ابزارهای قوی برای پیاده‌سازی مفاهیم Smart Money Concepts (SMC) و استراتژی‌های معاملاتی مبتنی بر FVG در اختیار معامله‌گران و توسعه‌دهندگان قرار می‌دهد. 🚀

---

## ✨ ویژگی‌ها

- **پشتیبانی از چند تایم‌فریم (MTF)**: امکان تحلیل ساختار بازار و FVG در تایم‌فریم‌های مختلف به صورت همزمان. 🕒
- **پشتیبانی از چند نماد**: قابلیت کار با هر نماد معاملاتی پشتیبانی‌شده توسط MetaTrader 5. 💹
- **مفاهیم Smart Money Concepts (SMC)**: شناسایی سقف‌های بالاتر (HH)، کف‌های بالاتر (HL)، سقف‌های پایین‌تر (LH)، کف‌های پایین‌تر (LL)، شکست ساختار (BoS) و تغییر کاراکتر (CHoCH). 📈
- **شناسایی شکاف ارزش منصفانه (FVG)**: تشخیص FVGهای صعودی و نزولی با فیلترهای قابل تنظیم و منطق ابطال در لحظه. 🔍
- **نمایش گرافیکی**: ترسیم نقاط محوری، نواحی FVG، سطوح فیبوناچی و لیبل‌های روند روی چارت با پسوند تایم‌فریم برای وضوح بیشتر. 🎨
- **مدیریت بهینه منابع**: محدود کردن ذخیره FVG به 30 مورد برای بهینه‌سازی عملکرد و مصرف حافظه. ⚙️
- **سیستم لاگ‌گیری**: ارائه لاگ‌های دقیق برای دیباگ و مانیتورینگ، با قابلیت فعال/غیرفعال کردن. 🖥️
- **سازگاری**: طراحی شده برای کار بدون مشکل در تمام نسخه‌های MetaTrader 5 بدون هشدار تبدیل نوع ضمنی. ✅

---

## 🛠️ اجزا

این کتابخانه شامل دو کلاس اصلی است که هر کدام جنبه خاصی از تحلیل بازار را مدیریت می‌کنند:

### 1. **کلاس MarketStructure** 📊
- **هدف**: تحلیل ساختار بازار بر اساس نقاط محوری و تشخیص روند.
- **ویژگی‌های کلیدی**:
  - شناسایی سقف‌ها و کف‌های محوری با استفاده از رویکرد فرکتالی. 🔝🔽
  - تشخیص جهت روند (صعودی، نزولی یا رنج) بر اساس الگوهای HH/HL و LL/LH.
  - ردیابی رویدادهای شکست ساختار (BoS) و تغییر کاراکتر (CHoCH).
  - ترسیم سطوح فیبوناچی پویا برای تأیید نقاط محوری (به طور پیش‌فرض 35% اصلاح).
  - نمایش نقاط محوری و لیبل‌های روند با پسوندهای خاص تایم‌فریم (مانند `(4H)` برای تایم‌فریم H4).

### 2. **کلاس FVGManager** 🔲
- **هدف**: مدیریت شناسایی و ابطال شکاف‌های ارزش منصفانه.
- **ویژگی‌های کلیدی**:
  - شناسایی FVGهای صعودی و نزولی بر اساس الگوهای سه کندلی با فیلتر بدنه قوی. 🕯️
  - ابطال FVGها در لحظه با استفاده از بررسی قیمت‌های Bid/Ask در هر تیک.
  - ترسیم نواحی FVG به صورت مستطیل روی چارت با لیبل‌های متنی متمرکز در ناحیه.
  - محدود کردن تعداد FVGها به 30 ناحیه برای جلوگیری از بار اضافی حافظه.
  - پشتیبانی از نمایش چند تایم‌فریمی با پسوندهای واضح تایم‌فریم.

---

## 🚀 راهنمای استفاده

### 1. **راه‌اندازی اولیه** 🏁
- نمونه‌هایی از کلاس‌های `MarketStructure` و `FVGManager` را در تابع `OnInit()` اکسپرت خود ایجاد کنید.
- مثال:
  ```cpp
  MarketStructure *H1_Struct = new MarketStructure(_Symbol, PERIOD_H1, ChartID(), true, true, 35, 10);
  FVGManager *H1_FVG = new FVGManager(_Symbol, PERIOD_H1, ChartID(), true, true);
  ```

### 2. **پردازش داده‌ها** 🔄
- **در OnTick() یا OnTimer()**:
  - متد `ProcessNewTick()` را برای `FVGManager` فراخوانی کنید تا ابطال FVG در هر تیک بررسی شود.
  - متد `ProcessNewBar()` را برای هر دو کلاس در زمان بسته شدن کندل جدید فراخوانی کنید تا ساختار بازار و FVGهای جدید به‌روزرسانی شوند.
- مثال:
  ```cpp
  if(IsNewBar(PERIOD_H1))
  {
      H1_Struct.ProcessNewBar();
      H1_FVG.ProcessNewBar();
  }
  H1_FVG.ProcessNewTick();
  ```

### 3. **دسترسی به داده‌ها** 📊
- از متدهای دسترسی برای استخراج داده‌های مورد نیاز برای منطق معاملاتی استفاده کنید:
  - `MarketStructure`:
    - `GetLastSwingHigh()`: آخرین سقف محوری را برمی‌گرداند.
    - `GetLastSwingLow()`: آخرین کف محوری را برمی‌گرداند.
    - `GetCurrentTrend()`: روند فعلی (صعودی، نزولی یا بدون روند) را برمی‌گرداند.
    - `GetLastChoChTime()`: زمان آخرین CHoCH را برمی‌گرداند.
    - `GetLastBoSTime()`: زمان آخرین BoS را برمی‌گرداند.
  - `FVGManager`:
    - `GetFVG(index)`: FVG در اندیس مشخص شده را برمی‌گرداند.
    - `GetFVGCount()`: تعداد FVGهای فعال را برمی‌گرداند.

### 4. **کنترل نمایش** 🖼️
- نمایش ترسیمات روی چارت را با پارامتر `showDrawing` در سازنده فعال یا غیرفعال کنید.
- عناصر بصری شامل:
  - نقاط محوری با فلش‌ها و لیبل‌ها (مانند `H (4H)` یا `L (4H)`).
  - نواحی FVG به صورت مستطیل‌های پرشده با لیبل‌های متنی متمرکز (مانند `FVG (4H)`).
  - فیبوناچی پویا برای ردیابی تأیید نقاط محوری.
  - لیبل‌های روند که وضعیت صعودی، نزولی یا رنج را نشان می‌دهند.

---

## 📋 پیش‌نیازها

- **پلتفرم**: MetaTrader 5 (پشتیبانی از تمام نسخه‌ها).
- **زبان برنامه‌نویسی**: MQL5.
- **وابستگی‌ها**: هیچ (کتابخانه مستقل).
- **حداقل تعداد کندل‌ها**: حداقل 4 کندل برای شناسایی FVG و `fractalLength * 2 + 1` کندل برای تحلیل اولیه ساختار بازار.

---

## 🛠️ نصب

1. **دانلود**: فایل `MarketStructureLibrary.mqh` را از این مخزن کلون یا دانلود کنید.
2. **قرار دادن در MetaTrader 5**: فایل را در پوشه `MQL5/Include` در محل نصب MetaTrader 5 کپی کنید.
3. **اضافه کردن به اکسپرت**: خط زیر را در ابتدای کد اکسپرت خود اضافه کنید:
   ```cpp
   #include <MarketStructureLibrary.mqh>
   ```
4. **کامپایل**: اکسپرت خود را در MetaEditor کامپایل کنید تا از اتصال صحیح کتابخانه اطمینان حاصل شود. 🔗

---

## 📖 مثال استفاده

در زیر یک اکسپرت ساده برای نشان دادن نحوه استفاده از کتابخانه ارائه شده است:

```cpp
#include <MarketStructureLibrary.mqh>

MarketStructure *structH1;
FVGManager *fvgH1;

int OnInit()
{
   structH1 = new MarketStructure(_Symbol, PERIOD_H1, ChartID(), true, true, 35, 10);
   fvgH1 = new FVGManager(_Symbol, PERIOD_H1, ChartID(), true, true);
   return(INIT_SUCCEEDED);
}

void OnDeinit(const int reason)
{
   delete structH1;
   delete fvgH1;
}

void OnTick()
{
   if(IsNewBar(PERIOD_H1))
   {
      structH1.ProcessNewBar();
      fvgH1.ProcessNewBar();
   }
   fvgH1.ProcessNewTick();

   // مثال: دسترسی به آخرین سقف محوری و روند
   SwingPoint lastHigh = structH1.GetLastSwingHigh();
   TREND_TYPE trend = structH1.GetCurrentTrend();
   Print("آخرین سقف محوری: ", DoubleToString(lastHigh.price, _Digits), " | روند: ", EnumToString(trend));
}

bool IsNewBar(ENUM_TIMEFRAMES timeframe)
{
   static datetime lastBar = 0;
   datetime currentBar = iTime(_Symbol, timeframe, 0);
   if(lastBar != currentBar)
   {
      lastBar = currentBar;
      return true;
   }
   return false;
}
```

---

## 🔧 سفارشی‌سازی

- **سطح تأیید فیبوناچی**: مقدار `fibUpdateLevel` را در سازنده `MarketStructure` تغییر دهید تا سطح اصلاح تغییر کند (پیش‌فرض: 35%).
- **طول فرکتال**: مقدار `fractalLength` را برای کنترل حساسیت شناسایی نقاط محوری تنظیم کنید (پیش‌فرض: 10 کندل).
- **لاگ‌گیری**: لاگ‌گیری را با پارامتر `enableLogging` فعال یا غیرفعال کنید.
- **نمایش بصری**: ترسیمات روی چارت را با پارامتر `showDrawing` فعال یا غیرفعال کنید.

---

## ⚠️ نکات

- **عملکرد**: کتابخانه برای عملکرد بهینه طراحی شده و تعداد FVGها را به 30 مورد محدود می‌کند تا از مشکلات حافظه جلوگیری شود.
- **مدیریت خطاها**: تمام توابع شامل بررسی‌هایی برای جلوگیری از کرش هستند، مانند اعتبارسنجی تعداد کندل‌ها و اندازه آرایه‌ها.
- **رفع هشدارها**: کتابخانه به‌روز شده تا تمام هشدارهای تبدیل نوع ضمنی را برطرف کند و با تنظیمات سخت‌گیرانه MQL5 سازگار باشد.

---

## 📬 تماس و پشتیبانی

برای سؤالات، گزارش باگ یا درخواست ویژگی‌های جدید، لطفاً یک مسئله (Issue) در این مخزن GitHub باز کنید. 📩

---

## 📄 مجوز

این پروژه تحت مجوز MIT منتشر شده است. برای جزئیات، فایل `LICENSE` را ببینید. 📜

---

**معامله موفقی داشته باشید!** 💰

</xaiArtifact>
